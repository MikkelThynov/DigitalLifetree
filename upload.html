<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Medier - Mit Digitale Livstræ</title>
    <link rel="stylesheet" href="upload.css" />
    <script type="module" src="supabase.js"></script>
  </head>
  <body>
    <header>
      <a href="index.html" class="back-btn">← Tilbage</a>
      <h1>Upload dine medier</h1>
      <input class="blad-label" id="bladLabel" />
    </header>
    <main>
      <div class="upload-box">
        <label for="fileInput">Vælg filer</label>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*,video/*,audio/*"
        />
        <div class="loader" id="loader"></div>
        <div class="preview-grid" id="preview"></div>
      </div>
    </main>

    <div class="lightbox" id="lightbox"></div>

    <!--------------------- Modal til upload af medier ------------------->
    <div id="mediaModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Tilføj indhold</h2>
        <div class="modal-grid">
          <button id="uploadImage">Billede</button>
          <button id="uploadVideo">Video</button>
          <button id="uploadAudio">Lydfil</button>
          <button id="recordAudio">Optag lyd</button>
          <button id="writeText">Tekst</button>
        </div>
        <div id="textInputContainer">
          <h3>Du kan tilføje din egen tekst her</h3>
          <input id="textInputTitle" placeholder="Skriv en titel"></input>
          <textarea
            id="textInput"
            placeholder="Skriv en tekst og klik på 'Gem' eller 'Annuller'..."
          ></textarea>
          <div class="text-buttons">
            <button id="saveText">Gem tekst</button>
            <button id="cancelText">Annuller</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { supabase } from "./supabase.js";

      const input = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const loader = document.getElementById("loader");
      const bladInput = document.getElementById("bladLabel");
      const params = new URLSearchParams(window.location.search);
      const bladId = params.get("blad") || "default";

      bladInput.value =
        localStorage.getItem(`bladnavn_${bladId}`) || `Blad ${bladId}`;
      bladInput.addEventListener("input", () => {
        localStorage.setItem(`bladnavn_${bladId}`, bladInput.value);
      });

      const openModalBtn = document.querySelector("label[for='fileInput']");
      const modal = document.getElementById("mediaModal");
      const closeModalBtn = document.querySelector(".close");

      openModalBtn.addEventListener("click", (e) => {
        e.preventDefault();
        modal.style.display = "block";
      });

      closeModalBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

      window.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });

      function showLoader(state) {
        loader.style.display = state ? "block" : "none";
      }

      function saveOrder() {
        const order = [...preview.children].map((div) => div.dataset.path);
        localStorage.setItem(`order_${bladId}`, JSON.stringify(order));
      }

      function createMediaCard(url, type, path) {
  console.log("Creating MediaCard:", { url, type, path }); // Debugging

  const container = document.createElement("div");
  container.setAttribute("draggable", "true");
  container.dataset.path = path;

  let element;
  if (type.startsWith("image/")) {
    element = document.createElement("img");
    element.src = url;
    element.draggable = false;
  } else if (type.startsWith("video/")) {
    element = document.createElement("video");
    element.src = url;
    element.controls = true;
    element.draggable = false;
    element.style.maxWidth = "100%";
  } else if (type.startsWith("audio/")) {
    const title = document.createElement("h3");
    title.textContent = "Lydfil"; // Eksempeltekst, kan ændres dynamisk
    container.appendChild(title);

    const subtitle = document.createElement("p");
    subtitle.textContent = "Afspil din fil her eller download den"; // Eksempeltekst
    container.appendChild(subtitle);

    element = document.createElement("audio");
    element.src = url;
    element.controls = true;
    element.draggable = false;
  } else if (type === "text") {
    const titleElement = document.createElement("h4");
    titleElement.contentEditable = true; // Gør redigerbar
    titleElement.textContent = url.title || "Titel";
    titleElement.style.marginBottom = "0.5rem";
    titleElement.style.fontWeight = "bold";

    const textElement = document.createElement("p");
    textElement.contentEditable = true; // Gør redigerbar
    textElement.textContent = url.text || "Tekstindhold";

    const saveTextBtn = document.createElement("button");
    saveTextBtn.textContent = "Gem ændringer";
    saveTextBtn.onclick = async () => {
      const newTitle = titleElement.textContent.trim();
      const newText = textElement.textContent.trim();

      const newPath = `blad-${bladId}/text-${Date.now()}.json`;
      const { error } = await supabase.storage
        .from("lifetree")
        .upload(
          newPath,
          new Blob([JSON.stringify({ title: newTitle, text: newText })], {
            type: "application/json",
          }),
          { upsert: true }
        );
      if (error) {
        console.error("Fejl ved gemning af tekst:", error);
        return;
      }

      // Fjern den gamle fil
      const { error: deleteError } = await supabase.storage
        .from("lifetree")
        .remove([path]);
      if (deleteError) console.error("Sletningsfejl:", deleteError);

      container.dataset.path = newPath;
      alert("Ændringer gemt!");
    };

    container.appendChild(titleElement);
    container.appendChild(textElement);
    container.appendChild(saveTextBtn);
    preview.appendChild(container);
    return;
  } else {
    console.error("Unsupported media type:", type);
    return; // Stop, hvis typen ikke understøttes
  }

  const removeBtn = document.createElement("button");
  removeBtn.className = "remove-btn";
  removeBtn.textContent = "×";
  removeBtn.onclick = async () => {
    preview.removeChild(container);
    const { error: deleteError } = await supabase.storage
      .from("lifetree")
      .remove([path]);
    if (deleteError) console.error("Sletningsfejl:", deleteError);
    saveOrder();
  };

  const editBtn = document.createElement("button");
  editBtn.className = "edit-btn";
  editBtn.textContent = "✎";
  editBtn.onclick = () => {
    openEditModal(url, type, path, container);
  };

  container.appendChild(removeBtn);
  container.appendChild(editBtn);
  container.appendChild(element);
  preview.appendChild(container);
}

function openEditModal(url, type, path, container) {
  const modal = document.createElement("div");
  modal.className = "edit-modal";
  modal.style.position = "fixed";
  modal.style.top = "50%";
  modal.style.left = "50%";
  modal.style.transform = "translate(-50%, -50%)";
  modal.style.background = "#fff";
  modal.style.padding = "1rem";
  modal.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  modal.style.zIndex = "1000";

  const closeModalBtn = document.createElement("button");
  closeModalBtn.textContent = "Luk";
  closeModalBtn.onclick = () => {
    document.body.removeChild(modal);
  };

  if (type.startsWith("image/") || type.startsWith("video/") || type.startsWith("audio/")) {
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = type.startsWith("image/")
      ? "image/*"
      : type.startsWith("video/")
      ? "video/*"
      : "audio/*";

    const saveBtn = document.createElement("button");
    saveBtn.textContent = "Vælg ny fil";
    saveBtn.onclick = async () => {
  fileInput.click(); // Åbn filupload-dialog
  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (file) {
      const newPath = `blad-${bladId}/${file.name}`;
      
      // Upload den nye fil til Supabase
      const { error: uploadError } = await supabase.storage
        .from("lifetree")
        .upload(newPath, file, { upsert: true });
      if (uploadError) {
        console.error("Upload-fejl:", uploadError);
        return;
      }

      // Hent den nye fil-URL
      const { data, error: urlError } = supabase.storage
        .from("lifetree")
        .getPublicUrl(newPath);
      if (urlError) {
        console.error("Fejl ved hentning af URL:", urlError);
        return;
      }

      // Opdater grid-elementet med den nye fil
      if (type.startsWith("image/")) {
        container.querySelector("img").src = data.publicUrl;
      } else if (type.startsWith("video/")) {
        container.querySelector("video").src = data.publicUrl;
      } else if (type.startsWith("audio/")) {
        container.querySelector("audio").src = data.publicUrl;
      }

      // Fjern den gamle fil fra Supabase
      const { error: deleteError } = await supabase.storage
        .from("lifetree")
        .remove([path]);
      if (deleteError) {
        console.error("Sletningsfejl:", deleteError);
      }

      // Opdater grid-elementets data-path til den nye fil
      container.dataset.path = newPath;

      // Fjern modal og gem rækkefølgen
      document.body.removeChild(modal);
      saveOrder();
    }
  };
};

    modal.appendChild(fileInput);
    modal.appendChild(saveBtn);
  } else if (type === "text") {
    alert("Redigering af tekst understøttes allerede via direkte redigering.");
  } else {
    alert("Denne medietype understøttes ikke.");
  }

  modal.appendChild(closeModalBtn);
  document.body.appendChild(modal);
}



      document.getElementById("uploadImage").onclick = () => {
        document.getElementById("fileInput").accept = "image/*";
        document.getElementById("fileInput").click();
        modal.style.display = "none";
        toggleTextInput(false);
      };

      document.getElementById("uploadVideo").onclick = () => {
        document.getElementById("fileInput").accept = "video/*";
        document.getElementById("fileInput").click();
        modal.style.display = "none";
        toggleTextInput(false);
      };

      document.getElementById("uploadAudio").onclick = () => {
        document.getElementById("fileInput").accept = "audio/*";
        document.getElementById("fileInput").click();
        modal.style.display = "none";
        toggleTextInput(false);
      };

      document.getElementById("recordAudio").onclick = () => {
        alert("Optag lyd-funktion kommer snart...");
        toggleTextInput(false);
      };

      document.getElementById("writeText").onclick = () => {
        toggleTextInput(true);
      };

      async function uploadTextToSupabase(title, text, path) {
  const { error } = await supabase.storage
    .from("lifetree")
    .upload(path, new Blob([JSON.stringify({ title, text })], { type: "application/json" }), { upsert: true });
  if (error) console.error("Fejl ved upload af tekst:", error);
}

document.getElementById("saveText").onclick = async () => {
  const title = document.getElementById("textInputTitle").value.trim();
  const text = document.getElementById("textInput").value.trim();

  if (title || text) {
    const path = `blad-${bladId}/text-${Date.now()}.json`;

    // Upload teksten til Supabase
    await uploadTextToSupabase(title, text, path);

    const div = document.createElement("div");
    div.className = "text-note";
    div.dataset.path = path;
    div.style.background = "#fff7e6";
    div.style.padding = "1rem";
    div.style.borderRadius = "8px";
    div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";
    div.style.maxWidth = "300px";

    if (title) {
      const titleElement = document.createElement("h4");
      titleElement.textContent = title;
      titleElement.style.marginBottom = "0.5rem";
      titleElement.style.fontWeight = "bold";
      div.appendChild(titleElement);
    }

    if (text) {
      const textElement = document.createElement("p");
      textElement.textContent = text;
      div.appendChild(textElement);
    }

    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-btn";
    removeBtn.textContent = "×";
    removeBtn.onclick = async () => {
      preview.removeChild(div);
      const { error: deleteError } = await supabase.storage
        .from("lifetree")
        .remove([path]);
      if (deleteError) console.error("Sletningsfejl:", deleteError);
      saveOrder();
    };

    div.appendChild(removeBtn);
    document.getElementById("preview").prepend(div);

    document.getElementById("textInputTitle").value = "";
    document.getElementById("textInput").value = "";
  }

  modal.style.display = "none";
  toggleTextInput(false);
};

      document.getElementById("cancelText").onclick = () => {
        document.getElementById("textInput").value = "";
        toggleTextInput(false);
      };

      async function uploadAndPreview(file) {
  showLoader(true);
  const filePath = `blad-${bladId}/${file.name}`;
  const { error } = await supabase.storage
    .from("lifetree")
    .upload(filePath, file, { upsert: true });
  if (error) {
    console.error("Upload-fejl:", error);
    showLoader(false);
    return;
  }

  const { data, error: urlError } = supabase.storage
    .from("lifetree")
    .getPublicUrl(filePath);
  if (urlError) {
    console.error("Fejl ved hentning af URL:", urlError);
    showLoader(false);
    return;
  }

  // Kontrollér filtypen og opret et MediaCard
  if (file.type.startsWith("audio/")) {
    createMediaCard(data.publicUrl, file.type, filePath);
  } else if (file.type.startsWith("image/")) {
    createMediaCard(data.publicUrl, file.type, filePath);
  } else if (file.type.startsWith("video/")) {
    createMediaCard(data.publicUrl, file.type, filePath);
  }

  showLoader(false);
  saveOrder();
}

      async function loadExistingMedia() {
  const { data, error } = await supabase.storage
    .from("lifetree")
    .list(`blad-${bladId}`);
  if (error) return console.error("Fejl ved hentning:", error);

  const order = JSON.parse(
    localStorage.getItem(`order_${bladId}`) || "[]"
  );
  const paths = data.map((item) => `blad-${bladId}/${item.name}`);

  const sorted = [...paths].sort(
    (a, b) => order.indexOf(a) - order.indexOf(b)
  );

  for (const path of sorted) {
    const name = path.split("/").pop();
    const ext = name.split(".").pop().toLowerCase();

    if (ext === "json") {
      // Håndter tekstfiler
      const { data: fileData, error: fetchError } = await supabase.storage
        .from("lifetree")
        .download(path);
      if (fetchError) {
        console.error("Fejl ved hentning af tekst:", fetchError);
        continue;
      }

      const textContent = await fileData.text();
      const { title, text } = JSON.parse(textContent);

      const div = document.createElement("div");
      div.className = "text-note";
      div.dataset.path = path;
      div.style.background = "#fff7e6";
      div.style.padding = "1rem";
      div.style.borderRadius = "8px";
      div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";
      div.style.maxWidth = "300px";

      if (title) {
        const titleElement = document.createElement("h4");
        titleElement.textContent = title;
        titleElement.style.marginBottom = "0.5rem";
        titleElement.style.fontWeight = "bold";
        div.appendChild(titleElement);
      }

      if (text) {
        const textElement = document.createElement("p");
        textElement.textContent = text;
        div.appendChild(textElement);
      }

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.textContent = "×";
      removeBtn.onclick = async () => {
        preview.removeChild(div);
        const { error: deleteError } = await supabase.storage
          .from("lifetree")
          .remove([path]);
        if (deleteError) console.error("Sletningsfejl:", deleteError);
        saveOrder();
      };

      div.appendChild(removeBtn);
      preview.appendChild(div);
    } else if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
      // Håndter billedfiler
      const { data: urlData } = supabase.storage
        .from("lifetree")
        .getPublicUrl(path);
      createMediaCard(urlData.publicUrl, `image/${ext}`, path);
    } else if (["mp4", "webm", "ogg", "mov"].includes(ext)) {
      // Håndter videofiler
      const { data: urlData } = supabase.storage
        .from("lifetree")
        .getPublicUrl(path);
      createMediaCard(urlData.publicUrl, "video/mp4", path);
    } else if (["mp3", "wav", "ogg"].includes(ext)) {
  // Håndter lydfiler
  const { data: urlData } = supabase.storage
    .from("lifetree")
    .getPublicUrl(path);
  createMediaCard(urlData.publicUrl, `audio/${ext}`, path);
}
  }
}

      input.addEventListener("change", () => {
        Array.from(input.files).forEach(uploadAndPreview);
        input.value = "";
      });

      document.addEventListener("click", (e) => {
        const lb = document.getElementById("lightbox");
        if (e.target.tagName === "IMG" || e.target.tagName === "VIDEO") {
          const clone = e.target.cloneNode(true);
          lb.innerHTML = "";
          lb.appendChild(clone);
          lb.style.display = "flex";
        } else if (e.target.id === "lightbox") {
          lb.style.display = "none";
        }
      });

      let dragged;
      document.addEventListener("dragstart", (e) => {
        dragged = e.target;
        e.target.style.opacity = 0.5;
      });
      document.addEventListener("dragend", (e) => {
        e.target.style.opacity = "";
      });
      document.addEventListener("dragover", (e) => e.preventDefault());
      document.addEventListener("drop", (e) => {
        e.preventDefault();
        const grid = document.querySelector(".preview-grid");
        if (e.target.closest(".preview-grid > div") && dragged) {
          grid.insertBefore(dragged, e.target.closest(".preview-grid > div"));
          saveOrder();
        }
      });

      loadExistingMedia();
    </script>
  </body>
</html>
